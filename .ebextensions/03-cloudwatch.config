container_commands:
  01_install_deps:
    command: |
      if [ ! -f /opt/elasticbeanstalk/tasks/bundlelogs.d/01-application.conf ]; then
        mkdir -p /opt/elasticbeanstalk/tasks/bundlelogs.d
      fi
    leader_only: true
    ignoreErrors: true

files:
  "/opt/elasticbeanstalk/tasks/bundlelogs.d/01-application.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/log/php-error.log
      /var/log/httpd/access_log
      /var/log/httpd/error_log
      /var/log/eb-activity.log
      /var/log/eb-engine.log

  "/home/ec2-user/send-cloudwatch-logs.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
      INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
      
      aws logs put-log-events \
        --log-group-name "/aws/elasticbeanstalk/library-app" \
        --log-stream-name "$INSTANCE_ID" \
        --log-events "timestamp=$(date +%s000),message=$(cat /var/log/php-error.log | tail -n 100)" \
        --region $REGION
